{% extends "base.html" %}
{% block title %}Study{% endblock %}
{% block study_active %}active{% endblock %}
{% block content %}

<style>
/*@media screen and (-webkit-min-device-pixel-ratio:0) { 
  select,
  textarea,
  input {
    font-size: 18px;
  }
}
@media screen and (-webkit-min-device-pixel-ratio:0) { 
  select:focus,
  textarea:focus,
  input:focus {
    font-size: 18px;
    background: #eee;
  }
}
*/
input[type='text'],
input[type='number'],
textarea {
  font-size: 18px;
  /*padding: 20px 10px;*/
}
#submit-answer, #answer-input {
    height: 45px;
  /*padding: 20px 10px;*/
}
p {
    font-size: 22px;
}
.card {
    /*width: 320px;*/
    width: 92%;
    max-width: 640px;
    background-color: #FCFCFC;
    margin: auto;
    padding: 15px;
    margin-top: 30px;
    border-radius: 2px;
    border-color: lightgray;
    border-width: 1px;
    box-shadow: 0 2px 2px 0 rgba(0,0,0,.14),0 3px 1px -2px rgba(0,0,0,.2),0 1px 5px 0 rgba(0,0,0,.12);
}
.card input {
    width: 80%;
    display: inline;
}
.card button {
    display: inline;
}
.card #incorrect-label {
    font-size: 18px;
    font-weight: 700;
    color: #DD0000;
    display: none;
}
.card #correct-label {
    font-size: 18px;
    font-weight: 500;
    color: #81DD00;
    display: none;
}
body {
    background-color: rgb(233,233,233);
}
#submit-answer {
    width: 75px;
}
</style>


<div class="card">
    <div class="question">{{ card.question }}</div>
    <div class="input-group">
      <input id="answer-input" type="text" placeholder="Answer" class="form-control" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
      <span class="input-group-btn">
        <button id="submit-answer" class="btn btn-primary" type="button">Submit</button>
      </span>
    </div><!-- /input-group -->
    <!-- </div> -->
    <div class="card-footer" style="
    border-top: 1px solid lightgray;
    margin-left: -15px;
    margin-right: -15px;
    margin-bottom: -15px;
    margin-top: 15px;
    padding: 10px 15px;
    background-color: #F7F7F7;
    height: 46px;
    ">
        <div id="incorrect-label" style="display: none;">Incorrect</div>
        <div id="correct-label" style="display: none;">Correct</div>
    </div>
</div>


<script src="/js/answer-validators.js"></script>
<script type="text/javascript">
    var card = {
        card_id: {{ card.card_id }},
        deck_id: {{ deck.deck_id }},
        answer: "{{ card.answer }}",
        first_attempt_correct: true,
        start_time: performance.now()
    }
    var session_id = {{ session_id }};
    // possible: correct, waiting_for_correct
    var state = "waiting_for_correct";
    var answer_validator = {{ deck.answer_validator }};

    function checkAnswer() {
        var userAnswer = $('#answer-input').val();
        if (state == "correct") {
            loadNextQuestion();
            state = "loading_next_question";
            $('#submit-answer').text('Submit');
        } else if (answer_validator(userAnswer, card.answer)) {
            card.time_to_correct = (performance.now() - card.start_time) / 1000.0;
            console.log('Time to correct: ' + card.time_to_correct);
            submitAnswerHistory(card);
            $('#incorrect-label').css('display', 'none');
            $('#correct-label').css('display', 'inline');
            $('#answer-input').val('');
            state = "correct";
            $('#submit-answer').text('Next');
            $('#submit-answer').attr('class', 'btn btn-success');
        } else if (state == "waiting_for_correct") {
            card.first_attempt_correct = false;
            $('#incorrect-label').css('display', 'inline');
            $('#correct-label').css('display', 'none');
        }
    }

    function loadNextQuestion() {
        $.post('/decks/'+card.deck_id+'/next_card', JSON.stringify({ 'session_id' : session_id }), function (data) {
            $('.question').html(data['question']);
            card = data;
            card.start_time = performance.now();
            card.first_attempt_correct = true;
            state = "waiting_for_correct";
            $('#submit-answer').attr('class', 'btn btn-primary');
            $('#correct-label').fadeOut();
        }, 'json');
    }

    function submitAnswerHistory(card) {
        var body = JSON.stringify({
            'session_id': session_id,
            'card_id': card.card_id,
            'time_to_correct': card.time_to_correct,
            'first_attempt_correct': card.first_attempt_correct,
        });
        console.log(body);
        $.post('/card/'+card.card_id+'/answer', body, function (data){ 
            // check for success?
        }, 'json')
        .fail(function(xhr, status, error) {
            // error handling
            console.log(xhr);
        });
    }

    $("#submit-answer").click(function() {
        checkAnswer();
    });

    $('#answer-input').keypress(function(e){
        if (e.which == 13) { // enter key pressed
            checkAnswer();
        }
    });

    $(document).ready(function() {
        $('#answer-input').focus();
    });

/*
$("input[type=text], textarea").mouseover(zoomDisable).mousedown(zoomEnable);
function zoomDisable(){
  $('head meta[name=viewport]').remove();
  $('head').prepend('<meta name="viewport" content="user-scalable=0" />');
}
function zoomEnable(){
  $('head meta[name=viewport]').remove();
  $('head').prepend('<meta name="viewport" content="user-scalable=1" />');
} */
</script>

{% endblock %}